#!/bin/bash

# Скрипт для первоначальной настройки сервера Ubuntu с NVM и PM2

# Выходить из скрипта при любой ошибке
set -e

# Обновление системы
echo "======================================="
echo "Обновление списка пакетов (apt update)..."
echo "======================================="
sudo apt-get update

echo "======================================="
echo "Обновление системы (apt upgrade)..."
echo "======================================="
sudo apt-get upgrade -y

# Установка базовых утилит
echo "======================================="
echo "Установка основного набора программ..."
echo "======================================="
sudo apt-get install -y \
    nginx \
    wget \
    zip \
    unzip \
    net-tools \
    curl \
    htop \
    ufw \
    build-essential

# Установка NVM (Node Version Manager)
echo "======================================="
echo "Установка NVM..."
echo "======================================="
# Скачиваем и запускаем официальный скрипт установки nvm
curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.7/install.sh | bash

# Загружаем nvm в текущую сессию, чтобы можно было использовать его сразу
export NVM_DIR="$HOME/.nvm"
[ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
[ -s "$NVM_DIR/bash_completion" ] && \. "$NVM_DIR/bash_completion"

# Установка последней LTS-версии Node.js с помощью NVM
echo "======================================="
echo "Установка последней LTS-версии Node.js..."
echo "======================================="
nvm install --lts
nvm alias default 'lts/*'

# Установка PM2 глобально через NPM
echo "======================================="
echo "Установка PM2 (Process Manager for Node.js)..."
echo "======================================="
npm install -g pm2

# Проверка версий установленных программ
echo "======================================="
echo "Проверка версий установленных программ:"
echo "======================================="
echo "Node.js: $(node -v)"
echo "NPM: $(npm -v)"
echo "PM2: $(pm2 --version)"
echo "Nginx: $(nginx -v 2>&1 | grep -o '[0-9./]*')"
echo "cURL: $(curl --version | head -n 1)"

# Настройка и включение брандмауэра (UFW)
echo "======================================="
echo "Настройка базовых правил брандмауэра (UFW)..."
echo "======================================="
sudo ufw allow ssh     # Разрешить подключения по SSH (порт 22)
sudo ufw allow http    # Разрешить HTTP трафик (порт 80)
sudo ufw allow https   # Разрешить HTTPS трафик (порт 443)
sudo ufw --force enable # Включить брандмауэр

echo "======================================="
echo "Статус брандмауэра:"
sudo ufw status verbose
echo "======================================="

echo "======================================="
echo "Установка и настройка завершены!"
echo "ВАЖНО: Перезайдите на сервер (выйдите и снова войдите по SSH) или выполните команду 'source ~/.bashrc', чтобы nvm и pm2 были доступны в новой сессии."
echo "======================================="
